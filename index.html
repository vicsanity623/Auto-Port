<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DevQuest Auto-Port</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d0d12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        :root {
            --bg: #0d0d12;
            --panel-bg: #161622;
            --header-bg: rgba(22, 22, 34, 0.98);
            --accent: #2979ff;
            --rust-color: #dea584;
            --js-color: #f7df1e;
            --text-main: #e0e0e0;
            --border: 1px solid rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            overflow: hidden; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER FIXED --- */
        header {
            height: calc(60px + env(safe-area-inset-top));
            padding-top: env(safe-area-inset-top); 
            background: var(--header-bg);
            border-bottom: var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 16px;
            padding-right: 16px;
            flex-shrink: 0;
            z-index: 1000;
        }

        .logo { font-weight: 800; font-size: 16px; color: #fff; display: flex; align-items: center; gap: 8px;}
        .file-badge { font-size: 10px; background: #333; padding: 2px 6px; border-radius: 4px; color: #aaa; }
        
        .actions { display: flex; gap: 10px; }

        .btn {
            background: #222;
            color: white;
            border: var(--border);
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
        }
        .btn-run { background: var(--accent); border: none; }
        .btn-convert { background: linear-gradient(45deg, #f7df1e, #dea584); color: #000; border: none; }

        /* --- LAYOUT --- */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* --- SIDEBAR FIXED --- */
        #sidebar {
            width: 240px;
            background: #0a0a0e;
            border-right: var(--border);
            display: flex;
            flex-direction: column;
            padding-top: calc(10px + env(safe-area-inset-top)); 
            transition: transform 0.3s ease;
            position: absolute;
            z-index: 100;
            height: 100%;
            top: 0;
            transform: translateX(-100%);
        }
        #sidebar.open { transform: translateX(0); }
        
        .sidebar-header { 
            padding: 10px 16px; 
            font-weight: bold; 
            color: #666; 
            font-size: 11px; 
            letter-spacing: 1px; 
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-add {
            background: #1f1f2e;
            border: 1px solid #333;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
        }
        
        .file-item {
            padding: 12px 16px;
            font-size: 14px;
            color: #aaa;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            border-left: 2px solid transparent;
        }
        .file-item:hover { background: #1f1f2e; }
        .file-item.active { background: #161622; color: #fff; border-left-color: var(--accent); }
        .file-name { display: flex; align-items: center; gap: 8px; }
        
        .icon-html { color: #e44d26; }
        .icon-css { color: #264de4; }
        .icon-js { color: #f7df1e; }
        .icon-rs { color: #dea584; }

        /* --- EDITOR AREA --- */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
        }

        textarea.code-editor {
            flex: 1;
            width: 100%;
            background: #161622;
            color: #dcdcdc;
            border: none;
            padding: 16px;
            font-family: 'SF Mono', 'Fira Code', Consolas, monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
        }

        /* --- BOTTOM PANEL FIXED --- */
        .bottom-panel {
            height: 40%;
            background: #fff;
            display: flex;
            flex-direction: column;
            border-top: var(--border);
            position: relative;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .panel-tabs {
            display: flex;
            background: #111;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }
        .tab {
            padding: 8px 16px;
            color: #888;
            font-size: 12px;
            cursor: pointer;
            border-right: 1px solid #333;
        }
        .tab.active { background: #222; color: #fff; }

        #preview-frame { width: 100%; height: 100%; border: none; background: white; display: none; }
        #console-output { 
            flex: 1; 
            width: 100%; 
            background: #0d0d12; color: #0f0; 
            padding: 10px; font-family: monospace; font-size: 12px; 
            overflow-y: auto; white-space: pre-wrap;
            display: block;
        }
        
        .log-rust { color: #dea584; border-left: 2px solid #dea584; padding-left: 5px; margin-bottom: 4px; }
        .log-js { color: #f7df1e; border-left: 2px solid #f7df1e; padding-left: 5px; margin-bottom: 4px;}
        .log-err { color: #ff5555; border-left: 2px solid #ff5555; padding-left: 5px; margin-bottom: 4px;}
        .log-sys { color: #666; font-style: italic; margin-bottom: 4px;}

        .overlay {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.5); z-index: 90;
            display: none;
        }
        .overlay.show { display: block; }

    </style>
</head>
<body>

    <header>
        <div class="logo">
            <button class="btn" onclick="toggleSidebar()">‚ò∞</button>
            DevQuest <span id="current-file-badge" class="file-badge">script.js</span>
        </div>
        <div class="actions">
            <button id="convert-btn" class="btn btn-convert" onclick="convertJsToRust()">‚ö° Auto-Port</button>
            <button class="btn btn-run" onclick="runProject()">‚ñ∂ Run</button>
        </div>
    </header>

    <div class="workspace">
        <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
        
        <!-- SIDEBAR -->
        <div id="sidebar">
            <div class="sidebar-header">
                PROJECT FILES
                <button class="btn-add" onclick="addNewFile()">+</button>
            </div>
            <div id="file-list"></div>
            <div style="padding: 10px; margin-top:auto">
                <button class="btn" style="width:100%; background:#333;" onclick="resetProject()">Reset Project</button>
            </div>
        </div>

        <!-- EDITOR -->
        <div class="editor-container">
            <textarea id="editor" class="code-editor" spellcheck="false" oninput="saveCurrentFile()"></textarea>
        </div>
    </div>

    <!-- OUTPUT -->
    <div class="bottom-panel">
        <div class="panel-tabs">
            <div id="tab-console" class="tab active" onclick="switchTab('console')">Console</div>
            <div id="tab-preview" class="tab" onclick="switchTab('preview')">Web Preview</div>
        </div>
        <div id="console-output"></div>
        <iframe id="preview-frame"></iframe>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW fail'));
            });
        }

        const defaultFiles = {
            'index.html': `<h1>JS vs Rust Logic Test</h1>\n<p>Open Console tab to see results.</p>`,
            'style.css': `body { background: #f0f0f0; font-family: sans-serif; padding: 20px; }`,
            'script.js': `// JavaScript Logic\nconsole.log('JS: Starting Loop...');\n\nlet count = 0;\nfor(let i=0; i<10; i++) {\n    count += i;\n}\n\nconsole.log('JS Result: ' + count);`,
            'game.js': `// Example Game Logic\nconst CONFIG = {\n  lives: 3,\n  name: 'Hero'\n};\n\nconsole.log('Game Loaded: ' + CONFIG.name);`
        };

        let files = JSON.parse(localStorage.getItem('devquest_files')) || defaultFiles;
        let activeFileName = 'script.js';

        function init() {
            renderFileList();
            loadFile(activeFileName);
        }

        // --- FILE MANAGEMENT ---
        function renderFileList() {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            
            Object.keys(files).sort().forEach(name => {
                const item = document.createElement('div');
                item.className = `file-item ${name === activeFileName ? 'active' : ''}`;
                
                let icon = 'üìÑ';
                if(name.endsWith('.html')) icon = '<span class="icon-html">‚óè</span>';
                if(name.endsWith('.css')) icon = '<span class="icon-css">‚óè</span>';
                if(name.endsWith('.js')) icon = '<span class="icon-js">‚óè</span>';
                if(name.endsWith('.rs')) icon = '<span class="icon-rs">‚óè</span>';

                item.innerHTML = `
                    <div class="file-name">${icon} ${name}</div>
                `;
                item.onclick = () => loadFile(name);
                list.appendChild(item);
            });
        }

        function addNewFile() {
            const name = prompt("Enter file name (e.g., utils.js, logic.rs):");
            if (name) {
                if (files[name]) {
                    alert("File already exists!");
                    return;
                }
                files[name] = "// New File\n";
                saveCurrentFile(); // Save currently open file first
                loadFile(name);
            }
        }

        function loadFile(name) {
            if(files[activeFileName]) files[activeFileName] = document.getElementById('editor').value;
            
            activeFileName = name;
            document.getElementById('editor').value = files[name];
            document.getElementById('current-file-badge').textContent = name;
            
            const convertBtn = document.getElementById('convert-btn');
            // Only show port button for JS files
            if (name.endsWith('.js')) convertBtn.style.display = 'block';
            else convertBtn.style.display = 'none';

            renderFileList();
            toggleSidebar(false);
        }

        function saveCurrentFile() {
            files[activeFileName] = document.getElementById('editor').value;
            localStorage.setItem('devquest_files', JSON.stringify(files));
        }

        function resetProject() {
            if(confirm("Reset all files to default?")) {
                files = JSON.parse(JSON.stringify(defaultFiles));
                localStorage.setItem('devquest_files', JSON.stringify(files));
                loadFile('script.js');
            }
        }

        function toggleSidebar(force) {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            const isOpen = sb.classList.contains('open');
            
            if (force === false || isOpen) {
                sb.classList.remove('open');
                ov.classList.remove('show');
            } else {
                sb.classList.add('open');
                ov.classList.add('show');
            }
        }

        // --- SMARTER AUTO-PORT ---
        function convertJsToRust() {
            const jsCode = files[activeFileName];
            if (!activeFileName.endsWith('.js')) return;

            // 1. Determine new filename (e.g., game.js -> game.rs)
            const newRsName = activeFileName.replace('.js', '.rs');

            let rsCode = `// Auto-Ported from ${activeFileName}\n// Note: Browser APIs (window, navigator) are commented out.\n\nfn main() {\n`;
            
            const lines = jsCode.split('\n');
            lines.forEach(line => {
                let l = line.trim();
                if(!l) return;

                // --- FIX 1: Strings (Single to Double Quotes) ---
                // Replace 'text' with "text", but ignore apostrophes inside words if possible
                // This is a simple regex swap, might need manual adjustment for complex cases
                l = l.replace(/'([^']*)'/g, '"$1"');

                // --- FIX 2: Comment out Browser/DOM specifics ---
                if (l.includes('window.') || l.includes('navigator.') || l.includes('document.') || l.includes('alert(')) {
                    rsCode += `    // [DOM API] ${l}\n`;
                    return;
                }
                
                // --- Conversion Logic ---
                if(l.startsWith('console.log')) {
                    const content = l.match(/console\.log\((.*)\)/);
                    if(content) {
                        // Check if printing a variable or string
                        if(content[1].trim().startsWith('"')) {
                            rsCode += `    println!(${content[1]});\n`;
                        } else {
                            rsCode += `    println!("{:?}", ${content[1]});\n`;
                        }
                    }
                }
                else if(l.startsWith('let ') || l.startsWith('const ') || l.startsWith('var ')) {
                    // Rust doesn't do "const object = {}" easily without structs. 
                    // If it looks like an object start, comment it out.
                    if (l.includes('={') || l.includes('= {')) {
                         rsCode += `    // [TODO: Define Struct] ${l}\n`;
                    } else {
                        let parts = l.replace('const ', 'let ').replace('let ', 'let mut ').replace('var ', 'let mut ');
                        rsCode += `    ${parts}\n`;
                    }
                }
                else if(l.startsWith('for')) {
                    if(l.includes('let i=0') && l.includes('i++')) {
                        const range = l.match(/i<(\d+)/);
                        if(range) {
                            rsCode += `    for i in 0..${range[1]} {\n`;
                        } else {
                            rsCode += `    // Complex loop: ${l}\n`;
                        }
                    } else {
                         rsCode += `    ${l} // Check Syntax\n`;
                    }
                }
                else if(l === '}') {
                    rsCode += "    }\n";
                }
                else {
                    rsCode += `    ${l}\n`;
                }
            });
            rsCode += "}\n";

            files[newRsName] = rsCode;
            localStorage.setItem('devquest_files', JSON.stringify(files));
            
            alert(`Ported to ${newRsName}!`);
            loadFile(newRsName);
        }

        // --- RUNNER ---
        function switchTab(tab) {
            document.getElementById('console-output').style.display = tab === 'console' ? 'block' : 'none';
            document.getElementById('preview-frame').style.display = tab === 'preview' ? 'block' : 'none';
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(tab === 'console') document.getElementById('tab-console').classList.add('active');
            if(tab === 'preview') document.getElementById('tab-preview').classList.add('active');
        }

        async function runProject() {
            const consoleDiv = document.getElementById('console-output');
            
            // RUN MODE: Depends on currently active file type
            let mode = activeFileName.endsWith('.rs') ? 'rust' : 'js';
            
            if (mode === 'js' || activeFileName.endsWith('.html')) {
                // ... JS Logic (Same as before) ...
                consoleDiv.innerHTML = '';
                log("System", `Running Web Preview (${activeFileName})...`, "log-sys");
                switchTab('preview'); 
                
                const html = files['index.html'] || '';
                const css = files['style.css'] || '';
                
                // If running a specific JS file, inject IT. Otherwise inject script.js
                let jsToRun = files['script.js'] || '';
                if(activeFileName.endsWith('.js')) {
                    jsToRun = files[activeFileName];
                }

                const combined = `
                    <html><style>${css}</style><body>${html}
                    <script>
                        const _log = console.log;
                        console.log = (...args) => {
                            _log(...args);
                            const msg = args.map(a => String(a)).join(' ');
                            window.parent.postMessage({type: 'log', msg: msg}, '*');
                        };
                        window.onerror = (e) => console.log("Error: " + e);
                    <\/script>
                    <script>try { ${jsToRun} } catch(e) { console.log(e); }<\/script>
                    </body></html>`;
                document.getElementById('preview-frame').srcdoc = combined;

            } else {
                // RUST LOGIC
                consoleDiv.innerHTML = '';
                log("System", `Compiling ${activeFileName} (Remote)...`, "log-sys");
                switchTab('console'); 
                
                const rustCode = files[activeFileName];
                try {
                    const req = await fetch('https://play.rust-lang.org/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            channel: "stable", mode: "debug", edition: "2021", crateType: "bin", tests: false, code: rustCode
                        })
                    });
                    const res = await req.json();
                    if(res.success) {
                        log("Rust", res.stdout, "log-rust");
                        if(res.stderr) log("System", res.stderr, "log-sys");
                    } else {
                        log("Error", res.stderr, "log-err");
                    }
                } catch(e) {
                    log("Error", "Connection failed. " + e.message, "log-err");
                }
            }
        }

        function log(src, msg, cls = '') {
            const div = document.getElementById('console-output');
            const line = document.createElement('div');
            line.className = cls;
            line.textContent = `[${src}] ${msg}`;
            div.appendChild(line);
            div.scrollTop = div.scrollHeight;
        }

        window.addEventListener('message', e => {
            if(e.data.type === 'log') log("JS", e.data.msg, "log-js");
        });

        init();
    </script>
</body>
</html>
